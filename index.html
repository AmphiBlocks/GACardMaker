<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom GA Card Maker</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <h1 id="header">Grand Archive Custom Card Imaginer</h1>
  <div id="content">

    <form id="cardForm">
      <table border=0 width="100%"><tr>
        <td><label for="artupload">Card Art:</label></td>
        <td align="right"><label>(Resize and Drag to fit)</label></td>
      </tr></table>
      <table border=0 width="100%"><tr>
        <td><input type="file" id="artupload" name="artupload" accept="image/*"/></td>
        <td><label class="pseudoButton" onclick="growArt()">+</label></td>
        <td><label class="pseudoButton" onclick="shrinkArt()">-</label></td>
      </tr></table></span>
      <input id="artURL" value="Paste URL to image" onfocus="this.value=''" oninput="updateArtByURL(this.value)">
      <input id="artPosition" value="top:0px;left:0px;width:700px;height:500px;" oninput="updateArtPosition(this.value)">
      <br><br>

      <label for="title">Card Title:</label>
      <input type="text" id="title" name="title" oninput="updateText('cardTitle', this.value)" value="Card Title">
      <br><br>

      <label for="element">Card Element:</label>
      <select id="element" name="element" onchange="
        updateImage('cardElementBackground', this.value, 'element-border-', true);
        updateImage('cardTypeBar', this.value, 'element-bar-', false, 'webp');
        updateImage('cardTypePoint', this.value, 'element-point-', false, 'webp');
      ">
        <option value="Norm">Norm</option>
        <option value="Fire">Fire</option>
        <option value="Water">Water</option>
        <option value="Wind">Wind</option>
        <option value="Arcane">Arcane</option>
        <option value="Astra">Astra</option>
        <option value="Crux">Crux</option>
        <option disabled value="Exia">Exia</option>
        <option value="Luxem">Luxem</option>
        <option value="Neos">Neos</option>
        <option disabled value="Techa">Techa</option>
        <option value="Tera">Tera</option>
        <option value="Umbra">Umbra</option>
        <option disabled value="Wrath">Wrath</option>
      </select>

      <br><br>

      <label for="costbubble">Card Cost Type:</label>
      <select id="costbubble" name="costbubble" onchange="updateImage('cardCostBubble', this.value, 'cost-')">
        <option value="Reserve">Reserve</option>
        <option value="Memory">Memory</option>
        <option value="Champion-0">Level 0</option>
        <option value="Champion-1">Level 1</option>
        <option value="Champion-2">Level 2</option>
        <option value="Champion-3">Level 3</option>
      </select>
      <br>

      <label for="cost">Card Cost:</label>
      <input type="number" id="cost" value="0" name="cost" min="0" max="9" pattern="[0-9]" oninput="updateImage('cardCost', this.value, '')">
      <br><br>

      <label for="subtype">Card Type:</label>
      <select id="subtype" name="subtype" onchange="updateImage('cardType', this.value, 'card-type-')">
        <option value="Ally">Ally</option>
        <option value="Action">Action</option>
        <option value="Champion">Champion</option>
        <option value="Domain">Domain</option>
        <option value="Item">Item</option>
        <option value="Phantasia">Phantasia</option>      
        <option value="Regalia">Regalia</option>      
        <option value="Weapon">Weapon</option>
        <option value="Skill">Skill</option>
      </select>
      <br>

      <label for="typedesc">Card Type Desc:</label>
      <input type="text" id="typedesc" name="typedesc" oninput="updateText('cardTypeText', this.value)" value="Ally - Tamer Ranger Animal Human">
      <br><br>

      <label for="effect">Card Effect:</label><br>
      <textarea id="effect" name="effect" value="Card Effect" oninput="updateText('cardEffect', this.value)">{bonus}Class Bonus{/bonus} +1{sword} <i>(Apply this ability only if your champion's class matches the card's class.)</i>
      <br><br> {tap} this card gains +1{heart}
      <br>
      <br><b>Floating Memory<b>
      </textarea>
    </form>

    <div id="cardContainer">
      <div id="cardArtClip">
        <img id="cardArt" src="art/talldefault.png" style="top:0px;left:0px;width:500px;height:700px;">
      </div>
      <div class="cardSection" id="cardElementBackground"></div>
      <canvas id="combinedCanvas"></canvas>
      <div class="cardSection" id="cardElement"></div>
      <div class="cardSection" id="cardTitle">Card Title</div>
      <div class="cardSection" id="cardTypeLine">
        <span class="cardSection" id="cardTypeText">Ally - Tamer Ranger Animal Human</span>
        <span id="cardTypeBar"> <span class="cardSection" id="spacerCardTypeText">Ally - Tamer Ranger Animal Human</span></span>
        <span id="cardTypePoint">&nbsp</span>
      </div>
      <div class="cardSection" id="cardType"></div>
      <div class="cardSection" id="cardCostBubble"></div>
      <div class="cardSection" id="cardCost"></div>
      <div class="cardSection" id="cardStats">
        <div class="cardSection" id="cardStatsFloater">
          <span class="cardSection" id="cardPower">4</span>
          <span class="cardSection" id="cardLife">4</span>
          <span class="cardSection" id="cardDurability">4</span>
        </div>
      </div>
      <div class="cardSection" id="cardEffectContainer"><span id="cardEffect">Card Effect</span></div>
      <div class="cardSection" id="cardSpeed"></div>
      <div class="cardSection" id="cardSetRarity"></div>
      <div class="cardSection" id="cardCopyright">©2024 Crux is Fines</div>
      <div class="cardSection" id="cardCoverContainer" data-html2canvas-ignore="true"></div>
      <div class="cardSection" id="cardRenderContainer"></div>
      <div id="cardRenderResults">
        <div id="cardRenderLog">Rendered above, right click to download!</div>
        <input id="cardShareURL"></input> <button id="copyURLButton">Copy URL for Sharing</button>
      </div>
    </div>


    <form id="cardForm">

      <label for="power">Card Power:</label>
      <input type="number" id="power" name="power" min="0" max="99" pattern="[0-9]" oninput="updateStats('cardPower', this.value, 'stat-power')">
      <br>

      <label for="life">Card Life:</label>
      <input type="number" id="life" name="life" min="0" max="99" pattern="[0-9]" oninput="updateStats('cardLife', this.value, 'stat-life')">
      <br>

      <label for="durability">Card Durability:</label>
      <input type="number" id="durability" name="durability" min="0" max="99" pattern="[0-9]" oninput="updateStats('cardDurability', this.value, 'stat-durability')">
      <br><br>

      <label for="speed">Card Speed:</label>
      <select id="speed" name="speed" onchange="updateImage('cardSpeed', this.value, 'speed-')">
        <option value="None">None</option>
        <option value="Fast">Fast</option>
        <option value="Slow">Slow</option>
      </select>
      <br><br>

      <label for="printing">Card Printing:</label>
      <table border=0 width="100%"><tr>
        <td>      <select id="printing" name="printing" onchange="
        updatePrinting(this.value);
      ">
        <option value="Regular">Regular</option>
        <option disabled value="Extended">Extended</option>
        <option value="CSR">CSR</option>
      </select></td>
        <td><label id="csrEraser" class="pseudoButton" onclick="toggleEraserMode()">CSR-style Background Eraser</label></td>
        <td><label>Brush Size</label></td><td><input id="eraserSize" type="number" value="20" style="width:50px"></td>
        <td><label id="revertEraser" class="pseudoButton" onclick="revertEraser()">Revert</label></td>
      </tr></table>      

      <br>

      <label for="setrarity">Card Set/Rarity:</label>
      <textarea id="setrarity" name="setrarity" oninput="updateText('cardSetRarity', this.value)">CUS {dot} EN - 001 {ultra rare} {dot} illust: Bing Chilling</textarea>
      <br>

      <label for="copyright">Copyright:</label>
      <textarea id="copyright" name="copyright" oninput="updateText('cardCopyright', this.value)">©2024 Crux is Fine</textarea>
      <br>

      <label id="renderWarning" style="visibility:visible"> Rendering temporarily disabled, take a screenshot instead. </label>
      <button id="renderButton" type="button" onclick="render()">Generate Share URL</button>

    </form>
  
</div>

  <script src="html2canvas.min.js"></script>
  <script src="jquery-3.7.1.min.js"></script>
  <script>

    let shouldErase = 0;
    let eraseProgress = 0;
    function toggleEraserMode() {
        eraserButton = document.getElementById('csrEraser');
        shouldErase = 1-shouldErase;
        if (eraseProgress==0){
          activateEraserMode();
        }

        if (shouldErase == 1){
          eraseProgress=1
          eraserButton.style.backgroundColor = "#Cff";
          
        } else {
          eraserButton.style.backgroundColor = "#fff";
        }
    }

    function activateEraserMode() {
    
      const cardContainer = document.getElementById('cardContainer');
      const canvas = document.getElementById('combinedCanvas');
      const bg_original = document.getElementById('cardElementBackground');
      const clipPath = window.getComputedStyle(bg_original).clipPath;

      const ctx = canvas.getContext('2d');
      const image = new Image();
      let bgImageStyle = bg_original.style.backgroundImage;
      if (bgImageStyle.startsWith('url("')) {
        bgImageStyle = bgImageStyle.slice(5, -2); // Removes `url("` at the beginning and `")` at the end
      } else if (bgImageStyle.startsWith('url(')) {
        bgImageStyle = bgImageStyle.slice(4, -1); // Removes `url(` at the beginning and `)` at the end
      }
      canvas.style.visibility='visible';
      image.src = bgImageStyle;

      image.onload = () => {
        const offCanvas = document.createElement('canvas');
        const offCtx = offCanvas.getContext('2d');
        offCanvas.width = image.width;
        offCanvas.height = image.height;

        // Apply clipping to the off-screen canvas
        applyClipPath(offCtx, clipPath, offCanvas.width, offCanvas.height);

        // Draw the image onto the off-screen canvas
        offCtx.drawImage(image, 0, 0);

        // Draw the off-screen canvas onto the main canvas
        canvas.width = offCanvas.width;
        canvas.height = offCanvas.height;
        ctx.drawImage(offCanvas, 0, 0);

        // Render additional elements
        renderElement(ctx, 'cardTypeBar', 0, () => {
            renderElement(ctx, 'cardTypePoint', -15, () => {
                    bg_original.style.visibility = 'hidden';
                    const cardTypeBar = document.getElementById('cardTypeBar');
                    cardTypeBar.style.visibility = 'hidden';
                    const cardTypePoint = document.getElementById('cardTypePoint');
                    cardTypePoint.style.visibility = 'hidden';
            });
         });
      };

      let isErasing = false;

      cardContainer.addEventListener('mousedown', (e) => {
        if (shouldErase){
          isErasing = true;
          erase(e);
        }
      });

      cardContainer.addEventListener('mousemove', (e) => {
        if (isErasing) erase(e);
      });

      cardContainer.addEventListener('mouseup', () => {
        isErasing = false;
      });

      cardContainer.addEventListener('mouseleave', () => {
        isErasing = false;
      });

      function erase(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const eraserSizeInput = document.getElementById('eraserSize');
        const radius = eraserSizeInput.value;
        const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
        gradient.addColorStop(0, 'rgba(0, 0, 0, 1)');
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

        ctx.globalCompositeOperation = 'destination-out';
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function revertEraser(){
      const canvas = document.getElementById('combinedCanvas');
      canvas.style.visibility='hidden';
      const bg_original = document.getElementById('cardElementBackground');
      bg_original.style.visibility='visible';
      const cardTypeBar = document.getElementById('cardTypeBar');
      cardTypeBar.style.visibility = 'visible';
      const cardTypePoint = document.getElementById('cardTypePoint');
      cardTypePoint.style.visibility = 'visible';      
      eraseProgress = 0;
      shouldErase=0;
      eraserButton = document.getElementById('csrEraser');
      eraserButton.style.backgroundColor = "#fff";
    }

    // Function to apply clipPath to a canvas context
    function applyClipPath(ctx, clipPath, width, height) {
      if (clipPath.startsWith('polygon')) {
        // Extract the points from the polygon clip-path
        const points = clipPath.match(/([\d\.]+%?)/g).map(value => {
          if (value.endsWith('%')) {
            // Convert percentage values to pixel values
            const percentage = parseFloat(value) / 100;
            return percentage * (value.includes('left') || value.includes('right') ? width : height);
          } else {
            return parseFloat(value);
          }
        });

        // Create a path based on the points
        ctx.beginPath();
        for (let i = 0; i < points.length; i += 2) {
          const x = points[i];
          const y = points[i + 1];
          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.closePath();
        ctx.clip();
      }
    }
    function baseURL() {
      return "";
    }

    function substituteTextForImages(text) {

      var substituteList = [
        ["{tap}",  "<img src='"+baseURL()+"images/inline-tap.png'>"],
        ["{sword}","<img src='"+baseURL()+"images/inline-sword.png'>"],
        ["{heart}","<img src='"+baseURL()+"images/inline-heart.png'>"],
        ["{common}","<img src='"+baseURL()+"images/common.png'>"],
        ["{uncommon}","<img src='"+baseURL()+"images/uncommon.png'>"],
        ["{rare}","<img src='"+baseURL()+"images/rare.png'>"],
        ["{super rare}","<img src='"+baseURL()+"images/super rare.png'>"],
        ["{ultra rare}","<img src='"+baseURL()+"images/ultra rare.png'>"],
        ["{collector super rare}","<img src='"+baseURL()+"images/collector super rare.png'>"],
        ["{collector ultra rare}","<img src='"+baseURL()+"images/collector ultra rare.png'>"],
        ["{promotional rare}","<img src='"+baseURL()+"images/promotional rare.png'>"],
        ["{dot}","<img src='"+baseURL()+"images/dot.png'>"],
        ["{bonus}","<span class=\"effect__icon\">"],
        ["{/bonus}","</span>"],

      ]
      var text2 = text;
      substituteList.forEach(x => text2=text2.replace(x[0], x[1]) );
      substituteList.forEach(x => text2=text2.replace(x[0], x[1]) );
      return text2;
    }

    function hideRenderContainer(){
      document.getElementById("cardCoverContainer").style.visibility="hidden";
      document.getElementById("cardRenderContainer").style.visibility="hidden";
      document.getElementById("cardRenderResults").style.visibility="hidden";      
    }

    function updateText(sectionId, value) {
      document.getElementById(sectionId).innerHTML = substituteTextForImages(value);
      hideRenderContainer();
      updateElementClipping();
      positionCardTypeText();
    }

    function updateImage(sectionId, value, format, respectprinting = false, imagetype = "png") {
        const suffix = (respectprinting && document.getElementById('printing').value === 'CSR') ? '-csr' : '';
        document.getElementById(sectionId).style.backgroundImage = `url('${baseURL()}images/${format.toLowerCase()}${value.toLowerCase()}${suffix}.${imagetype}')`;
        hideRenderContainer();
    }

    function updatePrinting(mode) {
        const styles = {
            whiteGlow: `
                text-shadow: 0 0 5px rgba(255, 255, 255, 1), 
                             0 0 10px rgba(255, 255, 255, 1),  
                             0 0 15px rgba(255, 255, 255, 1),
                             0 0 20px rgba(255, 255, 255, 1);
            `,
            whiteBoxGlow: `
                box-shadow: 0 0 5px rgba(255, 255, 255, 1), 
                             0 0 10px rgba(255, 255, 255, 1),  
                             0 0 15px rgba(255, 255, 255, 1),
                             0 0 20px rgba(255, 255, 255, 1); 
            `,
            blackGlow: `
                text-shadow: 0 0 5px rgba(0, 0, 0, 1), 
                             0 0 10px rgba(0, 0, 0, 1),  
                             0 0 15px rgba(0, 0, 0, 1),
                             0 0 20px rgba(0, 0, 0, 1);
            `,
            intenseWhiteGlow: `
                text-shadow:  0 0 2px rgba(255, 255, 255, 1),   
                              0 0 4px rgba(255, 255, 255, 1),   
                              0 0 6px rgba(255, 255, 255, 0.8), 
                              0 0 8px rgba(255, 255, 255, 0.6), 
                              -1px -1px 0 rgba(255, 255, 255, 1), 
                              1px -1px 0 rgba(255, 255, 255, 1), 
                              -1px 1px 0 rgba(255, 255, 255, 1), 
                              1px 1px 0 rgba(255, 255, 255, 1);  
            `,
            blackDropShadow: `
              filter: drop-shadow(0 0 5px rgba(0, 0, 0, 5)) 
                      drop-shadow(0 0 7px rgba(0, 0, 0, 0.5))
                      drop-shadow(0 0 10px rgba(0, 0, 0, 0.8));  
            `,
            whiteDropShadow: `
              filter: drop-shadow(0 0 5px rgba(255, 255, 255, 5)) 
                      drop-shadow(0 0 7px rgba(255, 255, 255, 0.5)) 
                      drop-shadow(0 0 10px rgba(255, 255, 255, 0.8));  
            `,
            noGlow: 'text-shadow: none;',
            noBoxGlow: 'box-shadow: none;',
            noDropShadow: 'filter:none;'
        };

        const fields = {
            whiteGlow: [
                '#cardTypeLine',
                '#cardEffect'
            ],
            blackGlow: [
                '#cardSetRarity',
                '#cardCopyright'
            ],
            intenseWhiteGlow: [
                '#cardTitle'
            ],
            whiteBoxGlow: [
                '.effect__icon'
            ],
            blackDropShadow: [
                '#cardSetRarity img'
            ],
            whiteDropShadow: [
                '#cardEffect img'
            ]
        };

        const applyStyle = (selectors, style, resetStyle) => {
            selectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(element => {
                    if (mode === 'CSR') {
                        element.style.cssText += style;
                    } else {
                        element.style.cssText += resetStyle;
                    }
                });
            });
        };

        applyStyle(fields.whiteGlow, styles.whiteGlow, styles.noGlow);
        applyStyle(fields.blackGlow, styles.blackGlow, styles.noGlow);
        applyStyle(fields.intenseWhiteGlow, styles.intenseWhiteGlow, styles.noGlow);
        applyStyle(fields.whiteBoxGlow, styles.whiteBoxGlow, styles.noBoxGlow);
        applyStyle(fields.blackDropShadow, styles.blackDropShadow, styles.noDropShadow);
        applyStyle(fields.whiteDropShadow, styles.whiteDropShadow, styles.noDropShadow);

        const element = document.getElementById('element').value;
        const borderElement = document.getElementById('cardElementBackground');
        if (mode === 'CSR') {
            borderElement.style.backgroundImage = `url('${baseURL()}images/element-border-${element.toLowerCase()}-CSR.png')`;
            document.getElementById('cardTypeBar').style.opacity = '0.5';
            document.getElementById('cardTypePoint').style.opacity = '0.5';
        } else {
            borderElement.style.backgroundImage = `url('${baseURL()}images/element-border-${element.toLowerCase()}.png')`;
            document.getElementById('cardTypeBar').style.opacity = '1';
            document.getElementById('cardTypePoint').style.opacity = '1';
        }
        updateElementClipping();
    }

    function updateElementClipping() {
        const mode = document.getElementById('printing').value;
        const cardTypeBar = document.getElementById('cardTypeBar');
        const cardTypePoint = document.getElementById('cardTypePoint');
        const cardElementBackground = document.getElementById('cardElementBackground');

        if (mode === 'CSR') {
            const barWidth = cardTypeBar.offsetWidth+54;
            cardElementBackground.style.clipPath = `polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 70.35%, 0% 67.5%, 8% 67.5%, 8% 70.35%, ${barWidth}px 70.35%, ${barWidth+13}px 67.5%,  ${barWidth}px 66.1%,  0% 66.1%)`;

        } else {
            cardElementBackground.style.clipPath = 'none';
        }
    }

    function updateArtByURL(value) {
    if(value == ""){
      return;
    }

    const cardArtElement = document.getElementById('cardArt');
    if(suppress_for_initial_load == false){
      cardArtElement.onload = function() {
          // Adjust size here
          const naturalWidth = cardArtElement.naturalWidth;
          const naturalHeight = cardArtElement.naturalHeight;
          const aspectRatio = naturalWidth / naturalHeight;

          let newWidth = naturalWidth;
          let newHeight = naturalHeight;

          if (newHeight < 400) {
              newHeight = 400;
              newWidth = newHeight * aspectRatio;
          }

          if (newWidth < 450) {
              newWidth = 450;
              newHeight = newWidth / aspectRatio;
          }

          if ((newWidth + parseInt(cardArtElement.style.left, 10)) < 400) cardArtElement.style.left="0px";
          if ((newHeight + parseInt(cardArtElement.style.top, 10)) < 450) cardArtElement.style.top="0px";

          cardArtElement.style.width = `${newWidth}px`;
          cardArtElement.style.height = `${newHeight}px`;

          $("#artPosition").prop('value', getCssText(document.getElementById('cardArt')));
      };
    };

    cardArtElement.src = value;
    $('#renderWarning').css("visibility", "visible");
    $('#renderButton').text("Generate Share URL");
    return;
}

    var suppress_for_initial_load = true

    function updateArtPosition(cssText) {
      const cardArt = document.getElementById('cardArt');
      
      // Split the cssText into individual style declarations
      const styles = cssText.split(';').filter(style => style.trim().length > 0);
      
      // Clear existing inline styles
      cardArt.style.cssText = '';

      // Apply each style declaration to cardArt
      styles.forEach(style => {
          const [key, value] = style.split(':').map(part => part.trim());
          cardArt.style[key] = value;
      });
    }

    function updateStats(sectionId, value, format) {
      var element = document.getElementById(sectionId);
      element.innerText = value;
      if (value==''){
        element.style.visibility=`hidden`;
        element.style.position=`absolute`;
      } else {
        element.style.visibility=`visible`;
        element.style.position=`relative`;
      }
      hideRenderContainer();
    }

    function render(){
      if (document.getElementById("cardRenderContainer").style.visibility!="hidden"){
        return;
      }
      if ($('#renderWarning').css("visibility") == "visible") {
        document.getElementById("cardRenderLog").innerHTML="Share URL Generated."
        document.getElementById("cardRenderResults").style.visibility="visible";
        return;
      }
      

          document.getElementById("cardCoverContainer").style.visibility="hidden";
          document.getElementById("cardRenderContainer").style.visibility="hidden";

          $("#cardCoverContainer").fadeOut(1, function(){
            document.getElementById("cardCoverContainer").style.visibility="visible";            
            $("#cardCoverContainer").fadeIn(100, function(){            
            $(".effect__icon").css({'padding': '1px 7px 1px 7px'});
            $("#cardTypeText").css({'bottom' : '2px'});

            html2canvas(document.querySelector("#cardContainer")).then(canvas => {
              $("#cardRenderContainer").replaceWith(canvas);
              canvas.id="cardRenderContainer";
              canvas.visibility = "hidden"              

              $("#cardRenderContainer").fadeOut(1, function(){

                document.getElementById("cardRenderContainer").style.visibility="visible";
                document.getElementById("cardRenderResults").style.visibility="visible";
                document.getElementById("cardRenderLog").innerText="Render Complete"  
                $("#cardRenderContainer").fadeIn(1000);
              });
            });
          });


      });
      
    }

    function renderElement(ctx, elementId, widthoffset, callback) {
        const element = document.getElementById(elementId);
        const rect = element.getBoundingClientRect();
        const cavnvas = document.getElementById('combinedCanvas');
        const canvasRect = cavnvas.getBoundingClientRect();
        const computedStyle = window.getComputedStyle(element);

        ctx.save();
        ctx.globalAlpha = parseFloat(computedStyle.opacity) || 1.0;

        const img = new Image();
        img.src = computedStyle.backgroundImage.slice(5, -2); // Extract URL
        img.onload = () => {
            ctx.drawImage(img, rect.left-canvasRect.left, rect.top-canvasRect.top, rect.width+widthoffset, rect.height);
            ctx.restore();
            console.log(`Rendered ${elementId}`);
            if (callback) callback();
        };
        img.onerror = (e) => {
            console.error(`Error loading image for ${elementId}`, e);
            ctx.restore();
            if (callback) callback();
        };
    }

    function growArt(){
      var width = $("#cardArt").width()
      var height = $("#cardArt").height()
      $("#cardArt").width(width/0.9)
      $("#cardArt").height(height/0.9)
      $("#artPosition").prop('value', getCssText(document.getElementById('cardArt')));
    }
    function shrinkArt(){
      var width = $("#cardArt").width()
      var height = $("#cardArt").height()
      $("#cardArt").width(width*0.9)
      $("#cardArt").height(height*0.9)
      $("#artPosition").prop('value', getCssText(document.getElementById('cardArt')));
    }

    function getCssText(element) {
        let cssText = '';
        const style = element.style;

        for (let i = 0; i < style.length; i++) {
            const key = style[i];
            const value = style.getPropertyValue(key);
            cssText += `${key}:${value};`;
        }

        return cssText;
    }

    dragElement(document.getElementById("cardContainer"), document.getElementById("cardArt"));

    function dragElement(dragTarget,mover) {
      var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        dragTarget.onmousedown = dragMouseDown;

      function dragMouseDown(e) {

        if(shouldErase) return;

        e = e || window.event;
        e.preventDefault();
        // get the mouse cursor position at startup:
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        // call a function whenever the cursor moves:
        document.onmousemove = elementDrag;
      }

      function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        // calculate the new cursor position:
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        // set the element's new position:
        mover.style.top = (mover.offsetTop - pos2) + "px";
        mover.style.left = (mover.offsetLeft - pos1) + "px";
        mover.style.height = (mover.height) + "px";
        mover.style.width = (mover.width) + "px";
      }

      function closeDragElement() {
        // stop moving when mouse button is released:
        document.onmouseup = null;
        document.onmousemove = null;
        $("#artPosition").prop('value', getCssText(document.getElementById('cardArt')));
      }
    }

    function positionCardTypeText() {
      const spacer = document.getElementById('spacerCardTypeText');
      const text = document.getElementById('cardTypeText');

      // Get the position and dimensions of the spacer
      const rect = spacer.getBoundingClientRect();

      // Position the text element to match the spacer
      //text.style.top = ((rect.top)-542) + 'px';

      //text.style.left = ((rect.left/4)) + 'px';
      text.style.left = ((spacer.offsetLeft/4)+9) +'px'
      text.style.width = 400 + 'px';

      spacer.innerText = text.innerText.slice(0, -2)
    }

    window.onresize = positionCardTypeText;    

    window.onload = function () {
      updateImage('cardElementBackground', document.getElementById('element').value, 'element-border-', true);
      updateImage('cardType', document.getElementById('subtype').value, 'card-type-');
      updateImage('cardCostBubble', document.getElementById('costbubble').value, 'cost-');
     
      updateImage('cardTypeBar', document.getElementById('element').value, 'element-bar-', false, 'webp');
      updateImage('cardTypePoint', document.getElementById('element').value, 'element-point-', false, 'webp');

      updateImage('cardCost', document.getElementById('cost').value, '')

      updateText('cardEffect', document.getElementById('effect').value);
      updateText('cardSetRarity', document.getElementById('setrarity').value);
      updateText('cardCopyright', document.getElementById('copyright').value);

      updateStats('cardPower', document.getElementById('power').value)
      updateStats('cardLife', document.getElementById('life').value)
      updateStats('cardDurability', document.getElementById('durability').value)

      updateImage('cardPower', 'stat-power', '');
      updateImage('cardLife', 'stat-life', '');
      updateImage('cardDurability', 'stat-durability', '');

      positionCardTypeText();
      
      $("#artupload").change(function(e) {
        $("#artURL").prop('value', "");
        //$('#renderWarning').css("visibility", "hidden");
        $('#renderButton').text("Generate Share URL (rendering disabled)");

        for (var i = 0; i < e.originalEvent.srcElement.files.length; i++) {
            
            var file = e.originalEvent.srcElement.files[i];
            
            var img = document.createElement("img");

            var reader = new FileReader();
            reader.onloadend = function() {
                 img.src = reader.result;
            }
            reader.readAsDataURL(file);
            $("#cardArt").replaceWith(img);
            img.id = "cardArt"
            dragElement(document.getElementById("cardContainer"), document.getElementById("cardArt"));
        }
      });
    };

    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const fields = [
            'artURL', 'artPosition', 'title', 'element', 'cost', 'subtype', 'typedesc',
            'effect', 'power', 'life', 'durability', 'speed', 'printing',
            'setrarity', 'copyright'
        ];

        function updateField(id, value) {
            const field = document.getElementById(id);
            if (field) {
                field.value = decodeURIComponent(value);
                field.dispatchEvent(new Event('input')); // Trigger input event for dynamic updates
            }
        }

        fields.forEach(field => {
            if (urlParams.has(field)) {
                updateField(field, urlParams.get(field));
            }
        });
        suppress_for_initial_load == false;
    });

    document.addEventListener('DOMContentLoaded', function() {
        const renderButton = document.querySelector('button[onclick="render()"]');
        const fields = [
            'artURL', 'artPosition', 'title', 'element', 'cost', 'subtype', 'typedesc',
            'effect', 'power', 'life', 'durability', 'speed', 'printing',
            'setrarity', 'copyright'
        ];

        function getFieldValue(id) {
            const field = document.getElementById(id);
            return field ? encodeURIComponent(field.value) : '';
        }

        function generateURL() {
            const baseURL = window.location.origin + window.location.pathname;
            const params = new URLSearchParams();
            
            fields.forEach(field => {
                const value = getFieldValue(field);
                if (value) {
                    params.append(field, value);
                }
            });
            
            return `${baseURL}?${params.toString()}`;
        }

        renderButton.addEventListener('click', function() {
            const generatedURL = generateURL();
            console.log('Generated URL:', generatedURL);
            $('#cardShareURL').prop("value", generatedURL);
        });
    });

    document.getElementById('copyURLButton').addEventListener('click', function() {
        const urlToCopy = document.getElementById('cardShareURL').value;
        navigator.clipboard.writeText(urlToCopy).then(() => {
            alert('URL copied to clipboard');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    });

  </script>
</body>
</html>